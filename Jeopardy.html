<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1"><title>Jeopardy ‚Äî Player vs AI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #111827;
    --panel: #1f2937;
    --board: #111827;
    --tile: #4f46e5;
    --tile-hover: #6366f1;
    --tile-text: #f59e0b;
    --ink: #e5e7eb;
    --ink-dim: #9ca3af;
    --border: #374151;
    --ok: #22c55e;
    --warn: #f59e0b;
    --err: #ef4444;
    --player: #3b82f6;
    --ai: #f43f5e;
    --font-heading: 'Montserrat', sans-serif;
    --font-body: 'Roboto', sans-serif;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: var(--font-body);
    background: var(--bg);
    color: var(--ink);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  .wrap{max-width:1200px;margin:0 auto;padding:16px;display:grid;gap:16px}
  .top{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
  .badge{padding:6px 12px;border-radius:999px;background:var(--panel);border:1px solid var(--border);color:var(--ink-dim); font-size: 0.9rem; font-weight: 700;}

  /* Scores Section */
  .scores{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
  .player-box{
    background:var(--panel);
    border:2px solid var(--player);
    border-radius:12px;
    padding:16px;
    text-align:center;
  }
  .player-box.active{
    box-shadow: 0 0 20px var(--player);
    animation: pulse 1.5s ease-in-out infinite;
  }
  .ai-box{
    background:var(--panel);
    border:2px solid var(--ai);
    border-radius:12px;
    padding:16px;
    text-align:center;
  }
  .ai-box.active{
    box-shadow: 0 0 20px var(--ai);
    animation: pulse 1.5s ease-in-out infinite;
  }
  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
  .player-name{font-size:0.9rem;color:var(--ink-dim);margin-bottom:4px}
  .player-score{font-size:2rem;font-weight:900;color:var(--player);font-family:var(--font-heading)}
  .ai-score{font-size:2rem;font-weight:900;color:var(--ai);font-family:var(--font-heading)}
  .turn-indicator{margin-top:8px;font-size:0.85rem;font-weight:700;color:var(--tile-text)}

  .board{
    background: var(--panel);
    border-radius: 16px;
    border: 1px solid var(--border);
    padding: 16px;
    display: grid;
    gap: 12px;
    box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3), 0 8px 10px -6px rgba(0,0,0,0.3);
  }
  .row{display:grid;gap:12px}
  .row-3{grid-template-columns:repeat(3,1fr)}
  .tile{
    display: grid;
    place-items: center;
    padding: 18px;
    border-radius: 12px;
    background: var(--tile);
    border: none;
    color: var(--tile-text);
    font-family: var(--font-heading);
    font-weight: 900;
    font-size: 1.6rem;
    cursor: pointer;
    min-height: 80px;
    text-align: center;
    user-select: none;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    transition: transform 0.15s ease, background-color 0.15s ease, box-shadow 0.15s ease;
    position: relative;
  }
  .tile:not(.used):hover{
    transform: scale(1.05);
    background: var(--tile-hover);
    box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
  }
  .tile.used{
    background: rgba(31, 41, 55, 0.5);
    color: #6b7280;
    cursor: not-allowed;
    text-shadow: none;
  }
  .tile.ai-thinking{
    animation: ai-glow 0.5s ease-in-out infinite alternate;
  }
  @keyframes ai-glow{
    from{box-shadow: 0 0 10px var(--ai)}
    to{box-shadow: 0 0 25px var(--ai)}
  }
  .cats{gap:12px;margin-bottom:8px}
  .cat{
    display: grid;
    place-items: center;
    padding: 10px;
    border-radius: 10px;
    background: var(--bg);
    color: var(--ink);
    border: 1px solid var(--border);
    font-family: var(--font-heading);
    font-weight: 700;
    min-height: 50px;
    text-align: center;
    font-size: 0.9rem;
  }

  .round-indicator{
    padding: 8px 16px;
    border-radius: 999px;
    background: var(--tile);
    border: 2px solid var(--tile-hover);
    color: white;
    font-weight: 900;
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 8px rgba(79, 70, 229, 0.4);
  }

  /* Buzzer Section */
  .buzzer-section{
    display:grid;
    gap:12px;
    margin-top:16px;
    grid-template-columns: 1fr 1fr;
  }
  .buzz-btn{
    padding: 20px;
    border-radius: 12px;
    font-size: 1.3rem;
    font-weight: 900;
    font-family: var(--font-heading);
    cursor: pointer;
    border: 3px solid;
    transition: all 0.15s ease;
    text-transform: uppercase;
  }
  .player-buzz{
    background: var(--player);
    border-color: var(--player);
    color: white;
  }
  .player-buzz:hover:not(:disabled){
    transform: scale(1.05);
    box-shadow: 0 0 30px var(--player);
  }
  .player-buzz:disabled{
    opacity: 0.3;
    cursor: not-allowed;
  }
  .player-buzz.winner{
    animation: buzz-winner 0.5s ease;
    box-shadow: 0 0 40px var(--player);
  }
  .ai-buzz{
    background: var(--ai);
    border-color: var(--ai);
    color: white;
    cursor: default;
  }
  .ai-buzz.winner{
    animation: buzz-winner 0.5s ease;
    box-shadow: 0 0 40px var(--ai);
  }
  @keyframes buzz-winner{
    0%,100%{transform:scale(1)}
    50%{transform:scale(1.1)}
  }

  .qhead{display:flex;align-items:center;justify-content:space-between;gap:10px; flex-wrap: wrap;}
  .qtext{font-size:1.2rem;line-height:1.6;color:#ffffff; font-weight: 500; margin: 8px 0;}
  .choices{display:grid;gap:10px;margin-top:16px}
  .choice{
    display:flex;gap:12px;align-items:center;padding:14px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--ink);cursor:pointer;
    transition: transform 0.15s ease, background-color 0.15s ease;
    text-align: left;
    font-size: 1rem;
    line-height: 1.4;
  }
  .choice:hover:not(:disabled){background:#374151; transform: translateY(-2px);}
  .choice.correct{border-color:var(--ok); background:rgba(34, 197, 94, 0.1); color: var(--ok);}
  .choice.wrong{border-color:var(--err); background:rgba(239, 68, 68, 0.1); color: var(--err);}
  .choice > strong { color: var(--tile-text); }
  .choice.correct > strong, .choice.wrong > strong { color: inherit; }

  .explanation{
    margin-top: 16px;
    padding: 16px;
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid #3b82f6;
    border-radius: 10px;
    line-height: 1.6;
  }
  .explanation h4{
    margin: 0 0 8px 0;
    color: #3b82f6;
    font-size: 1.1rem;
  }
  .explanation p{
    margin: 8px 0;
    color: var(--ink);
  }
  .explanation small{
    color: var(--ink-dim);
    font-style: italic;
  }

  .meta{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .kpi{font-variant-numeric:tabular-nums;font-weight:700; color: var(--tile-text);}
  .btn{
    padding: 10px 16px;
    border: 1px solid var(--border);
    border-radius: 10px;
    background: #374151;
    color: var(--ink);
    cursor: pointer;
    font-weight: 700;
    transition: transform 0.15s ease, background-color 0.15s ease;
  }
  .btn:hover{background: #4b5563; transform: translateY(-2px);}
  .btn.ghost{background:transparent;color:var(--ink-dim);border-color:var(--border)}
  .btn.ghost:hover{color: var(--ink); background: var(--panel);}
  .center{text-align:center}
  .hidden{display:none}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  
  .timer {
    display:flex;
    align-items:center;
    gap:8px;
  }
  #qTimer {
    background:var(--bg);
    border:1px solid var(--border);
    padding: 6px 12px;
    border-radius: 999px;
  }
  .bar{height:10px;background:var(--bg);border-radius:999px;overflow:hidden;width:100px;border:1px solid var(--border)}
  .bar>div{
    height:100%;
    background:linear-gradient(90deg, var(--ok), var(--warn), var(--err));
    width:100%;
    transition: width 1s linear;
  }

  .overlay{position:fixed;inset:0;pointer-events:none; z-index: 200;}
  .confetti i{position:absolute;width:8px;height:14px;opacity:.95;animation:fall 1.6s linear forwards}
  @keyframes fall{to{transform:translateY(120vh) rotate(360deg);opacity:.2}}

  .modal{
    position:fixed;
    inset:0;
    background:rgba(17, 24, 39, 0.9);
    backdrop-filter: blur(4px);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:16px;
    z-index:100;
    opacity: 0;
    transform: scale(0.98);
    pointer-events: none;
    visibility: hidden;
    transition: opacity 0.2s ease, transform 0.2s ease, visibility 0s 0.2s;
  }
  .modal.show{
    opacity: 1;
    transform: scale(1);
    pointer-events: auto;
    visibility: visible;
    transition: opacity 0.2s ease, transform 0.2s ease, visibility 0s 0s;
  }
  .card{
    background: var(--panel);
    color: var(--ink);
    border: 1px solid var(--border);
    border-radius: 16px;
    max-width: 650px;
    width: 100%;
    padding: 24px;
    display: grid;
    gap: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    max-height: 90vh;
    overflow-y: auto;
  }
  .card h2{margin:0;font-family: var(--font-heading); font-size:1.6rem; color: var(--tile-text);}
  .input{display:flex;gap:8px;align-items:center}
  .input input{flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--ink); font-size: 1rem;}

  #gameEndModal .card {
      padding: 0;
      overflow: hidden;
      text-align: center;
      max-width: 500px;
  }
  .endGameContent {
      padding: 24px;
      display: grid;
      gap: 12px;
  }
  .endGameContent h2 {
      font-size: 2.2rem;
      color: var(--tile-text);
      margin-bottom: 5px;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.4);
  }
  .endGameContent .final-scores{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 16px 0;
  }
  .endGameContent .score-box{
      padding: 12px;
      border-radius: 10px;
      border: 2px solid;
  }
  .endGameContent .player-final{
      border-color: var(--player);
      background: rgba(59, 130, 246, 0.1);
  }
  .endGameContent .ai-final{
      border-color: var(--ai);
      background: rgba(244, 63, 94, 0.1);
  }
  .endGameContent p {
      color: var(--ink-dim);
      line-height: 1.5;
  }
  #finalRestartBtn {
      background: var(--tile);
      color: #fff;
      font-size: 1.1rem;
      padding: 12px 24px;
      border: none;
      box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
  }
  #finalRestartBtn:hover {
      background: var(--tile-hover);
      box-shadow: 0 6px 15px rgba(79, 70, 229, 0.5);
  }

  .round-transition{
    position:fixed;
    inset:0;
    background:rgba(17, 24, 39, 0.95);
    backdrop-filter: blur(8px);
    display:flex;
    flex-direction: column;
    align-items:center;
    justify-content:center;
    z-index:150;
    opacity: 0;
    pointer-events: none;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0s 0.3s;
  }
  .round-transition.show{
    opacity: 1;
    pointer-events: auto;
    visibility: visible;
    transition: opacity 0.3s ease, visibility 0s 0s;
  }
  .round-transition h1{
    font-family: var(--font-heading);
    font-size: 3.5rem;
    color: var(--tile-text);
    margin: 0;
    text-shadow: 0 0 30px rgba(245, 158, 11, 0.5);
    animation: glow 2s ease-in-out infinite;
  }
  @keyframes glow{
    0%,100%{text-shadow: 0 0 30px rgba(245, 158, 11, 0.5)}
    50%{text-shadow: 0 0 50px rgba(245, 158, 11, 0.8)}
  }
  .round-transition p{
    font-size: 1.3rem;
    color: var(--ink);
    margin-top: 16px;
  }

  @media (max-width:780px){ 
    .row-3{grid-template-columns:1fr} 
    .tile{min-height:56px} 
    .qtext{font-size:1.05rem}
    .scores{grid-template-columns:1fr}
    .buzzer-section{grid-template-columns:1fr}
    .round-transition h1{font-size: 2.5rem}
  }
</style>
</head>
<body>

<div class="wrap">
  <div class="top">
    <div class="badge">Electrical Systems Jeopardy ‚Äî Player vs AI</div>
    <div class="meta">
      <span class="round-indicator" id="roundIndicator">ROUND 1: JEOPARDY</span>
      <span>Tiles left: <span class="kpi" id="qLeft">15</span></span>
      <button id="mute" class="btn ghost">üîà Sound</button>
      <button id="difficultyBtn" class="btn ghost">AI: Medium</button>
    </div>
  </div>

  <div class="scores">
    <div class="player-box" id="playerBox">
      <div class="player-name">YOU</div>
      <div class="player-score" id="pScore">$0</div>
      <div class="turn-indicator" id="playerTurn"></div>
    </div>
    <div class="ai-box" id="aiBox">
      <div class="player-name">AI OPPONENT</div>
      <div class="ai-score" id="aiScore">$0</div>
      <div class="turn-indicator" id="aiTurn"></div>
    </div>
  </div>

  <div class="board">
    <div class="cats row row-3" id="catRow"></div>
    <div class="row row-3" id="valRow1"></div>
    <div class="row row-3" id="valRow2"></div>
    <div class="row row-3" id="valRow3"></div>
    <div class="row row-3" id="valRow4"></div>
    <div class="row row-3" id="valRow5"></div>
  </div>
</div>

<div class="round-transition" id="roundTransition">
  <h1 id="transitionTitle">DOUBLE JEOPARDY</h1>
  <p id="transitionSubtitle">All values are doubled!</p>
</div>

<div class="modal" id="qCard">
  <div class="card">
    <div class="qhead">
      <div class="meta"><span id="qCat" class="badge"></span><span id="qValue" class="badge"></span></div>
      <div class="meta">
        <div class="timer" id="qTimer">
          <span>Time:</span>
          <div class="bar"><div id="tFill"></div></div>
          <span class="kpi" id="tLeft">10</span>s
        </div>
        <span class="badge" id="ddBadge" style="display:none;background:var(--warn);border-color:var(--warn);color:#111;">DAILY DOUBLE</span>
      </div>
    </div>
    <div class="qtext" id="qText">Question</div>
    
    <div id="buzzSection" class="buzzer-section hidden">
      <button class="buzz-btn player-buzz" id="playerBuzz" disabled>üîµ BUZZ IN!</button>
      <button class="buzz-btn ai-buzz" id="aiBuzz">üî¥ AI</button>
    </div>

    <div class="choices" id="choices"></div>
    <div id="feedback" class="center"></div>
    <div class="center" style="margin-top:10px;">
      <button id="closeQ" class="btn hidden">Continue</button>
    </div>
  </div>
</div>

<div class="modal" id="finalCard">
  <div class="card">
    <div class="qhead">
      <div class="meta"><span class="badge" id="finalCat">Final Category</span></div>
      <div class="meta"><span class="badge" style="background:#a855f7;border-color:#a855f7;color:#fff;">FINAL JEOPARDY</span></div>
    </div>
    <div class="qtext" id="finalText">Final question text‚Ä¶</div>
    <div class="choices" id="finalChoices"></div>
    <div id="finalFeedback" class="center"></div>
    <div class="center" style="margin-top:10px;">
      <button id="closeFinal" class="btn hidden">See Results</button>
    </div>
  </div>
</div>

<div class="overlay confetti" id="confetti"></div>

<div class="modal" id="ddModal">
  <div class="card">
    <h2 id="ddTitle">DAILY DOUBLE!</h2>
    <div id="ddWho"></div>
    <div id="ddScoreDisplay"></div>
    <div id="ddWagerSection"></div>
    <div class="meta" id="ddButtons"></div>
  </div>
</div>

<div class="modal" id="fjModal">
  <div class="card">
    <h2>FINAL JEOPARDY</h2>
    <div>Category: <b id="fjCat">Category</b></div>
    <div style="margin:16px 0">
      <div style="margin-bottom:8px">Your Score: <b class="kpi" style="color:var(--player)" id="fjPScore">$0</b></div>
      <div class="input"><span>Your Wager: $</span><input id="fjPWager" type="number" min="0" step="50" value="0"></div>
    </div>
    <div style="margin:16px 0">
      <div style="margin-bottom:8px">AI Score: <b class="kpi" style="color:var(--ai)" id="fjAIScore">$0</b></div>
      <div>AI Wager: <b class="kpi" style="color:var(--ai)" id="fjAIWager">$???</b> (Hidden)</div>
    </div>
    <div class="meta">
      <button id="fjStart" class="btn">Reveal Final Question</button>
    </div>
  </div>
</div>

<div class="modal" id="gameEndModal">
  <div class="card">
    <div class="endGameContent">
      <h2 id="endGameTitle">Game Over!</h2>
      <div class="final-scores">
        <div class="score-box player-final">
          <div style="font-size:0.9rem;color:var(--ink-dim)">YOU</div>
          <div class="kpi" style="color:var(--player);font-size:1.8rem" id="endPlayerScore">$0</div>
        </div>
        <div class="score-box ai-final">
          <div style="font-size:0.9rem;color:var(--ink-dim)">AI</div>
          <div class="kpi" style="color:var(--ai);font-size:1.8rem" id="endAIScore">$0</div>
        </div>
      </div>
      <p id="endGameMessage">Thanks for playing!</p>
      <button id="finalRestartBtn" class="btn">Play Again</button>
    </div>
  </div>
</div>

<script>
/* ========================================================================
   QUESTION BANK - CUSTOMIZE THIS SECTION FOR DIFFERENT JEOPARDY GAMES
   ========================================================================

   TO CREATE A NEW JEOPARDY GAME:
   1. Keep the structure exactly the same
   2. Change category names (must have exactly 6 categories + FINAL)
   3. Update questions, answers, and explanations for your topic
   4. Each category needs exactly 5 questions
   5. Round 1 categories use base values: $100, $200, $300, $400, $500
   6. Round 2 categories use doubled values: $200, $400, $600, $800, $1000

   STRUCTURE:
   - First 3 categories = Round 1 (Jeopardy)
   - Next 3 categories = Round 2 (Double Jeopardy) 
   - FINAL = Final Jeopardy question

   ======================================================================== */

const SAFETY_HUMAN_FACTORS_QUESTIONS = {
    "ESD Protection": [
        {
            value: 100,
            question: "This symbol, typically showing a hand inside a triangle, warns that components inside are sensitive to this type of electrical discharge.",
            answer: "What is ESD (Electrostatic Discharge)?",
            difficulty: "easy"
        },
        {
            value: 200,
            question: "This is the minimum voltage of static electricity that can damage sensitive avionics components, even though humans can't feel it until around 3,000 volts.",
            answer: "What is 100 volts (or as low as 10-100 volts)?",
            difficulty: "medium"
        },
        {
            value: 300,
            question: "These two essential pieces of equipment must be worn and properly grounded when working on ESD-sensitive avionics components.",
            answer: "What are a wrist strap and heel grounders (or ESD smock)?",
            difficulty: "easy"
        },
        {
            value: 400,
            question: "This type of material, used for work surfaces and storage, safely dissipates static charges rather than allowing buildup or rapid discharge.",
            answer: "What is static-dissipative material (or conductive material, typically 10^6 to 10^9 ohms resistance)?",
            difficulty: "medium"
        },
        {
            value: 500,
            question: "According to ESD standards, wrist straps should have this resistance value to safely dissipate charge while protecting the technician from electrical shock.",
            answer: "What is 1 megohm (1 MŒ©) resistance?",
            difficulty: "hard"
        }
    ],
    
    "Shop Safety": [
        {
            value: 100,
            question: "This document must be readily available for every chemical used in the shop, providing hazard information and emergency procedures.",
            answer: "What is a Safety Data Sheet (SDS) or Material Safety Data Sheet (MSDS)?",
            difficulty: "easy"
        },
        {
            value: 200,
            question: "When working with avionics equipment in an aircraft, this personal protective equipment protects your eyes from debris, chemical splashes, and wire ends.",
            answer: "What are safety glasses (or safety goggles)?",
            difficulty: "easy"
        },
        {
            value: 300,
            question: "This minimum safe distance, typically measured in feet, should be maintained from energized radar antennas during ground testing due to RF radiation hazards.",
            answer: "What is 10 feet (or per manufacturer specifications, often 25-50 feet for weather radar)?",
            difficulty: "medium"
        },
        {
            value: 400,
            question: "These lockout/tagout procedures are required when servicing avionics equipment to prevent this potentially fatal hazard.",
            answer: "What is accidental energization (or unexpected startup/electrical shock)?",
            difficulty: "medium"
        },
        {
            value: 500,
            question: "This OSHA regulation (29 CFR 1910.147) mandates specific procedures for controlling hazardous energy during maintenance operations.",
            answer: "What is the Control of Hazardous Energy standard (or Lockout/Tagout - LOTO)?",
            difficulty: "hard"
        }
    ],
    
    "Human Factors": [
        {
            value: 100,
            question: "These 12 factors, including stress, fatigue, and lack of communication, are common contributors to maintenance errors according to the FAA.",
            answer: "What are the Dirty Dozen (or 12 Human Factors)?",
            difficulty: "easy"
        },
        {
            value: 200,
            question: "This human factor occurs when a technician becomes overly confident and takes shortcuts, often after years of experience.",
            answer: "What is complacency (or overconfidence)?",
            difficulty: "easy"
        },
        {
            value: 300,
            question: "This type of distraction, often from supervisors or coworkers, is a leading cause of skipped steps or incomplete tasks in avionics maintenance.",
            answer: "What is interruption (or lack of communication/distraction)?",
            difficulty: "medium"
        },
        {
            value: 400,
            question: "This safety principle states that technicians should stop and verify their work when they sense something isn't right, rather than continuing blindly.",
            answer: "What is assertiveness (or speaking up/stop-work authority)?",
            difficulty: "medium"
        },
        {
            value: 500,
            question: "Studies show that human performance degrades significantly after this many consecutive hours of work, increasing error rates by over 50%.",
            answer: "What is 10-12 hours (or during night shifts/circadian rhythm disruption)?",
            difficulty: "hard"
        }
    ],
    
    "Tool Safety": [
        {
            value: 100,
            question: "This practice of accounting for all tools before and after a maintenance task prevents this serious aviation hazard.",
            answer: "What is FOD (Foreign Object Debris/Damage)?",
            difficulty: "easy"
        },
        {
            value: 200,
            question: "These specialized pliers with soft, non-marring jaws should be used when handling coaxial connectors to prevent damage.",
            answer: "What are connector installation/removal tools (or safety-wire pliers/specialized RF tools)?",
            difficulty: "medium"
        },
        {
            value: 300,
            question: "Before using any cutting or crimping tool, technicians should verify this critical characteristic to ensure proper force and fit.",
            answer: "What is calibration (or proper adjustment/jaw alignment)?",
            difficulty: "medium"
        },
        {
            value: 400,
            question: "When using a torque wrench on avionics rack fasteners, this common mistake can cause the wrench to slip and damage equipment or injure the technician.",
            answer: "What is exceeding the wrench's maximum rated torque (or pulling instead of pushing)?",
            difficulty: "hard"
        },
        {
            value: 500,
            question: "This specific tool control program, required by many airlines and military operations, uses individual accountability and tracking systems to prevent lost tools.",
            answer: "What is a Tool Control Program (or shadowed toolboxes/CTK - Consolidated Tool Kit system)?",
            difficulty: "hard"
        }
    ],
    
    "Hazardous Materials": [
        {
            value: 100,
            question: "This cleaning solvent, once common in avionics shops, is now heavily regulated due to ozone depletion and carcinogenic properties.",
            answer: "What is trichloroethylene (TCE) or methyl ethyl ketone (MEK)?",
            difficulty: "medium"
        },
        {
            value: 200,
            question: "This PPE must be worn when handling flux, solvents, or corrosion removal chemicals to prevent skin absorption and burns.",
            answer: "What are chemical-resistant gloves (nitrile or neoprene)?",
            difficulty: "easy"
        },
        {
            value: 300,
            question: "These fumes, released when soldering wire or components, can cause respiratory irritation and should be controlled with ventilation.",
            answer: "What is flux smoke (or rosin flux fumes/lead fumes)?",
            difficulty: "medium"
        },
        {
            value: 400,
            question: "This hazard classification system uses diamonds with colored sections and numbers to quickly identify health, flammability, and reactivity risks.",
            answer: "What is the NFPA 704 diamond (or HMIS - Hazardous Materials Identification System)?",
            difficulty: "hard"
        },
        {
            value: 500,
            question: "These specific fibers, found in older aircraft insulation and gaskets, require special handling procedures and disposal due to severe lung disease risks.",
            answer: "What is asbestos (requiring OSHA-certified abatement procedures)?",
            difficulty: "hard"
        }
    ],
    
    "FINAL": {
        value: 0,
        category: "CAET FINAL - Safety & Human Factors",
        question: "According to Boeing's maintenance error studies, this percentage of all aviation maintenance errors can be attributed to just three human factors: lack of communication, complacency, and fatigue - emphasizing why human factors training is critical for avionics technicians.",
        answer: "What is approximately 60-70% (or the majority) of maintenance errors?",
        difficulty: "final"
    }
};


/* ========================================================================
   END OF CUSTOMIZABLE QUESTION BANK SECTION
   ======================================================================== */

/* Game State */
const GameState = {
  TILE_SELECTION: 'TILE_SELECTION',
  QUESTION_READING: 'QUESTION_READING',
  BUZZER_ACTIVE: 'BUZZER_ACTIVE',
  ANSWERING: 'ANSWERING',
  SHOWING_RESULT: 'SHOWING_RESULT',
  DAILY_DOUBLE: 'DAILY_DOUBLE',
  ROUND_TRANSITION: 'ROUND_TRANSITION',
  FINAL_JEOPARDY: 'FINAL_JEOPARDY',
  GAME_OVER: 'GAME_OVER'
};

let gameState = GameState.TILE_SELECTION;
let currentRound = 1; // 1 = Jeopardy, 2 = Double Jeopardy
let tiles = {};
let playerScore = 0, aiScore = 0;
let currentTurn = 'player';
let currentQ = null;
let buzzWinner = null;
let dailyDoubleIds = [];
let questionsLeft = 15;
let aiBuzzTimeout = null;

/* AI Settings */
const AI_DIFFICULTY = {
  easy: { reactionMin: 2000, reactionMax: 3500, accuracy: 0.55, name: 'Easy' },
  medium: { reactionMin: 1500, reactionMax: 2500, accuracy: 0.70, name: 'Medium' },
  hard: { reactionMin: 1000, reactionMax: 2000, accuracy: 0.80, name: 'Hard' },
  expert: { reactionMin: 800, reactionMax: 1500, accuracy: 0.88, name: 'Expert' }
};
let currentDifficulty = 'medium';

/* Timer */
let TMAX = 10, t = TMAX, tInt = null, soundOn = true;
/* Track current Daily Double wager so timeouts score correctly */
let currentDDWager = 0;

/* DOM */
const $ = s => document.querySelector(s);
const catRow = $('#catRow'), qLeft = $('#qLeft');
const pScore = $('#pScore'), aiScoreEl = $('#aiScore');
const playerBox = $('#playerBox'), aiBox = $('#aiBox');
const playerTurn = $('#playerTurn'), aiTurn = $('#aiTurn');
const rows = [$('#valRow1'), $('#valRow2'), $('#valRow3'), $('#valRow4'), $('#valRow5')];
const qCard = $('#qCard'), qCat = $('#qCat'), qValue = $('#qValue'), qText = $('#qText');
const choices = $('#choices'), feedback = $('#feedback'), closeQ = $('#closeQ');
const buzzSection = $('#buzzSection'), playerBuzz = $('#playerBuzz'), aiBuzz = $('#aiBuzz');
const qTimer = $('#qTimer'), tFill = $('#tFill'), tLeft = $('#tLeft');
const ddBadge = $('#ddBadge'), ddModal = $('#ddModal');
const confetti = $('#confetti');
const muteBtn = $('#mute'), difficultyBtn = $('#difficultyBtn');
const fjModal = $('#fjModal'), fjCat = $('#fjCat'), fjStart = $('#fjStart');
const fjPScore = $('#fjPScore'), fjAIScore = $('#fjAIScore'), fjPWager = $('#fjPWager'), fjAIWager = $('#fjAIWager');
const finalCard = $('#finalCard'), finalCat = $('#finalCat'), finalText = $('#finalText');
const finalChoices = $('#finalChoices'), finalFeedback = $('#finalFeedback'), closeFinal = $('#closeFinal');
const gameEndModal = $('#gameEndModal'), endGameTitle = $('#endGameTitle');
const endPlayerScore = $('#endPlayerScore'), endAIScore = $('#endAIScore'), endGameMessage = $('#endGameMessage');
const finalRestartBtn = $('#finalRestartBtn');
const roundIndicator = $('#roundIndicator');
const roundTransition = $('#roundTransition'), transitionTitle = $('#transitionTitle'), transitionSubtitle = $('#transitionSubtitle');

/* Audio */
let AC = null;
function ensureAudio() { if (!AC) { AC = new (window.AudioContext || window.webkitAudioContext)(); } if (AC.state === 'suspended') { AC.resume(); } }
function play(freq = 880, ms = 180, type = 'sine', gain = 0.06) {
  if (!soundOn) return;
  ensureAudio();
  const o = AC.createOscillator(), g = AC.createGain();
  o.type = type; o.frequency.value = freq;
  g.gain.value = gain; g.gain.setValueAtTime(gain, AC.currentTime);
  g.gain.exponentialRampToValueAtTime(0.0001, AC.currentTime + ms / 1000);
  o.connect(g); g.connect(AC.destination); o.start(); o.stop(AC.currentTime + ms / 1000);
}
function chordOK() { play(987, 140, 'sine', 0.08); setTimeout(() => play(1479, 160, 'sine', 0.07), 110); }
function buzzer() {
  if (!soundOn) return; ensureAudio();
  const o = AC.createOscillator(), g = AC.createGain(); o.type = 'square';
  o.frequency.setValueAtTime(120, AC.currentTime); o.frequency.exponentialRampToValueAtTime(70, AC.currentTime + 0.35);
  g.gain.value = 0.08; g.gain.setValueAtTime(0.08, AC.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, AC.currentTime + 0.4);
  o.connect(g); g.connect(AC.destination); o.start(); o.stop(AC.currentTime + 0.42);
}
function selectBlip() { play(660, 90, 'triangle', 0.06); }
function tick() { play(660, 45, 'sine', 0.03); }
function buzzSound() { play(800, 200, 'square', 0.1); }

function celebrate() {
  const colors = ["#22c55e", "#3b82f6", "#eab308", "#a855f7", "#f43f5e"];
  for (let i = 0; i < 26; i++) {
    const p = document.createElement('i');
    p.style.left = Math.random() * 100 + '%';
    p.style.top = '-10px';
    p.style.background = colors[Math.floor(Math.random() * colors.length)];
    p.style.transform = 'rotate(' + Math.random() * 360 + 'deg)';
    p.style.animationDelay = (Math.random() * 0.2) + 's';
    confetti.appendChild(p);
    setTimeout(() => p.remove(), 1700);
  }
}

function updateTurnIndicator() {
  playerBox.classList.toggle('active', currentTurn === 'player');
  aiBox.classList.toggle('active', currentTurn === 'ai');
  
  if (gameState === GameState.TILE_SELECTION) {
    playerTurn.textContent = currentTurn === 'player' ? 'üëâ Your Turn to Select' : '';
    aiTurn.textContent = currentTurn === 'ai' ? 'üëâ AI is Selecting...' : '';
  } else {
    playerTurn.textContent = '';
    aiTurn.textContent = '';
  }
}

/* Validate the structure up front so bad data fails fast */
function validateBank() {
  const cats = Object.keys(QUESTION_BANK).filter(k => k !== 'FINAL');
  if (cats.length !== 6) throw new Error(`QUESTION_BANK must have exactly 6 categories (+ FINAL). Found ${cats.length}.`);
  cats.forEach(c => {
    const arr = QUESTION_BANK[c];
    if (!Array.isArray(arr) || arr.length !== 5) {
      throw new Error(`Category "${c}" must contain exactly 5 items (has ${Array.isArray(arr) ? arr.length : 'invalid'}).`);
    }
    arr.forEach((q, i) => {
      if (!Array.isArray(q.answers) || q.answers.length !== 4) {
        throw new Error(`"${c}" item ${i+1} must have exactly 4 answers.`);
      }
      if (q.correctIndex < 0 || q.correctIndex > 3) {
        throw new Error(`"${c}" item ${i+1} has invalid correctIndex (expected 0‚Äì3).`);
      }
    });
  });
}

function init() {
  validateBank();

  const allCategoryNames = Object.keys(QUESTION_BANK).filter(k => k !== "FINAL");
  // Get first 3 categories for Round 1
  const round1Categories = allCategoryNames.slice(0, 3);
  
  playerScore = 0;
  aiScore = 0;
  currentRound = 1;
  currentTurn = 'player';
  gameState = GameState.TILE_SELECTION;
  currentQ = null;
  buzzWinner = null;
  aiBuzzTimeout = null;
  dailyDoubleIds = [];
  currentDDWager = 0;

  pScore.textContent = '$' + playerScore;
  aiScoreEl.textContent = '$' + aiScore;
  roundIndicator.textContent = 'ROUND 1: JEOPARDY';

  qCard.classList.remove('show');
  finalCard.classList.remove('show');
  gameEndModal.classList.remove('show');
  ddModal.classList.remove('show');
  fjModal.classList.remove('show');
  roundTransition.classList.remove('show');

  loadRound(round1Categories, 1);
}

function loadRound(categories, roundNum) {
  currentRound = roundNum;
  const baseValues = roundNum === 1 ? [100, 200, 300, 400, 500] : [200, 400, 600, 800, 1000];
  
  tiles = {};
  const allRoundQuestions = [];

  categories.forEach(catName => {
    const pool = QUESTION_BANK[catName] || [];

    // Guard: ensure exactly 5 per category
    if (pool.length !== 5) {
      throw new Error(`Category "${catName}" must have exactly 5 questions (has ${pool.length}).`);
    }

    pool.forEach((q, idx) => {
      const id = `${catName}-${baseValues[idx]}`;
      tiles[id] = { 
        ...q,
        id,
        category: catName,      // store the real category
        used: false,
        pointValue: baseValues[idx]
      };
      allRoundQuestions.push(tiles[id]);
    });
  });

  questionsLeft = categories.length * baseValues.length;
  qLeft.textContent = questionsLeft;

  catRow.innerHTML = '';
  categories.forEach(c => {
    const el = document.createElement('div');
    el.className = 'cat';
    el.textContent = c;
    catRow.appendChild(el);
  });

  rows.forEach((r, i) => {
    r.innerHTML = '';
    const v = baseValues[i];
    categories.forEach(catName => {
      const id = `${catName}-${v}`;
      const t = document.createElement('button');
      t.className = 'tile';
      t.textContent = `$${v}`;
      t.dataset.id = id;

      if (tiles[id]) {
        t.addEventListener('click', () => {
          if (gameState === GameState.TILE_SELECTION && currentTurn === 'player' && !tiles[id].used) {
            openTile(id, t);
          }
        });
      }
      r.appendChild(t);
    });
  });

  // Select Daily Doubles for this round
  const candidates = allRoundQuestions.filter(q => q.difficulty >= 3 && q.pointValue >= (roundNum === 1 ? 300 : 600));
  const numDailyDoubles = roundNum === 1 ? 1 : 2;
  dailyDoubleIds = [];
  
  for (let i = 0; i < numDailyDoubles && candidates.length > 0; i++) {
    const idx = Math.floor(Math.random() * candidates.length);
    dailyDoubleIds.push(candidates[idx].id);
    candidates.splice(idx, 1);
  }

  updateTurnIndicator();
}

function openTile(id, btn) {
  const data = tiles[id];
  if (!data || data.used) return;
  
  data.used = true;
  btn.classList.add('used');
  btn.innerHTML = '‚Äî';
  selectBlip();
  
  const isDailyDouble = dailyDoubleIds.includes(id);
  
  if (isDailyDouble) {
    showDailyDouble(data);
  } else {
    showQuestion(data);
  }
}

function aiSelectTile() {
  const availableTiles = Object.values(tiles).filter(t => !t.used);
  if (availableTiles.length === 0) {
    if (currentRound === 1) {
      startRound2();
    } else {
      openFinalJeopardy();
    }
    return;
  }

  gameState = GameState.TILE_SELECTION;
  updateTurnIndicator();

  availableTiles.forEach(t => {
    const btn = document.querySelector(`[data-id="${t.id}"]`);
    if (btn) btn.classList.add('ai-thinking');
  });

  setTimeout(() => {
    let selected;
    if (aiScore < playerScore - 300) {
      const highValue = availableTiles.filter(t => t.pointValue >= (currentRound === 1 ? 400 : 800));
      selected = highValue.length > 0 ? highValue[Math.floor(Math.random() * highValue.length)] : availableTiles[0];
    } else {
      selected = availableTiles[Math.floor(Math.random() * availableTiles.length)];
    }

    availableTiles.forEach(t => {
      const btn = document.querySelector(`[data-id="${t.id}"]`);
      if (btn) btn.classList.remove('ai-thinking');
    });

    const btn = document.querySelector(`[data-id="${selected.id}"]`);
    openTile(selected.id, btn);
  }, 1000 + Math.random() * 1000);
}

function startRound2() {
  gameState = GameState.ROUND_TRANSITION;
  
  // Determine who starts Round 2 (lower score)
  if (playerScore < aiScore) {
    currentTurn = 'player';
  } else if (aiScore < playerScore) {
    currentTurn = 'ai';
  } else {
    currentTurn = 'player';
  }
  
  transitionTitle.textContent = 'DOUBLE JEOPARDY';
  transitionSubtitle.textContent = 'All values are doubled! ' + (currentTurn === 'player' ? 'You start this round!' : 'AI starts this round!');
  roundTransition.classList.add('show');
  
  setTimeout(() => {
    roundTransition.classList.remove('show');
    roundIndicator.textContent = 'ROUND 2: DOUBLE JEOPARDY';
    
    // Load Round 2 categories (second set of 3)
    const allCategoryNames = Object.keys(QUESTION_BANK).filter(k => k !== "FINAL");
    const round2Categories = allCategoryNames.slice(3, 6);
    
    loadRound(round2Categories, 2);
    
    gameState = GameState.TILE_SELECTION;
    updateTurnIndicator();
    
    if (currentTurn === 'ai') {
      setTimeout(() => aiSelectTile(), 1000);
    }
  }, 3000);
}

function showDailyDouble(data) {
  currentQ = data;
  const isDDOwner = currentTurn;
  
  ddModal.classList.add('show');
  $('#ddWho').innerHTML = isDDOwner === 'player' 
    ? '<div style="color:var(--player);font-weight:700">You found the Daily Double!</div>'
    : '<div style="color:var(--ai);font-weight:700">AI found the Daily Double!</div>';
  
  const score = isDDOwner === 'player' ? playerScore : aiScore;
  $('#ddScoreDisplay').innerHTML = `Current Score: <b class="kpi">$${score}</b>`;
  
  if (isDDOwner === 'player') {
    const maxWager = Math.max(currentRound === 1 ? 1000 : 2000, score);
    $('#ddWagerSection').innerHTML = `
      <div>Wager an amount (min $100, max $${maxWager}):</div>
      <div class="input"><span>$</span><input id="ddWagerInput" type="number" min="100" max="${maxWager}" value="${Math.min(maxWager, currentRound === 1 ? 500 : 1000)}" step="50"></div>
    `;
    $('#ddButtons').innerHTML = '<button id="ddStartBtn" class="btn">Answer Question</button>';
    $('#ddStartBtn').addEventListener('click', () => {
      const wager = Math.max(100, Math.min(maxWager, Number($('#ddWagerInput').value) || 100));
      ddModal.classList.remove('show');
      showQuestion(data, true, wager);
    });
  } else {
    const maxWager = Math.max(currentRound === 1 ? 1000 : 2000, score);
    const aiWager = Math.floor(maxWager * (0.3 + Math.random() * 0.5));
    $('#ddWagerSection').innerHTML = `<div>AI is considering their wager...</div>`;
    $('#ddButtons').innerHTML = '';
    
    setTimeout(() => {
      $('#ddWagerSection').innerHTML = `<div>AI wagers: <b class="kpi">$${aiWager}</b></div>`;
      setTimeout(() => {
        ddModal.classList.remove('show');
        showQuestion(data, true, aiWager);
      }, 1500);
    }, 2000);
  }
}

function showQuestion(data, isDailyDouble = false, ddWager = 0) {
  currentQ = data;
  gameState = GameState.QUESTION_READING;
  buzzWinner = null;
  currentDDWager = isDailyDouble ? ddWager : 0; // remember DD wager
  
  qCard.classList.add('show');
  
  // Use stored category instead of parsing the id
  const catName = data.category;
  qCat.textContent = catName;
  qValue.textContent = '$' + data.pointValue;
  qText.textContent = data.question;
  choices.innerHTML = '';
  feedback.innerHTML = '';
  closeQ.classList.add('hidden');
  buzzSection.classList.add('hidden');
  ddBadge.style.display = isDailyDouble ? 'inline-block' : 'none';
  
  if (isDailyDouble) {
    qTimer.style.visibility = 'visible';
    startAnswerTimer(data.timeLimit || 15);
    
    setTimeout(() => {
      gameState = GameState.ANSWERING;
      showAnswerChoices(isDailyDouble, ddWager);
    }, 2000);
  } else {
    qTimer.style.visibility = 'hidden';
    
    setTimeout(() => {
      gameState = GameState.BUZZER_ACTIVE;
      showBuzzerSection();
    }, 3000);
  }
}

function showBuzzerSection() {
  buzzSection.classList.remove('hidden');
  playerBuzz.disabled = false;
  playerBuzz.classList.remove('winner');
  aiBuzz.classList.remove('winner');
  buzzSound();
  
  const aiSettings = AI_DIFFICULTY[currentDifficulty];
  const aiReactionTime = aiSettings.reactionMin + Math.random() * (aiSettings.reactionMax - aiSettings.reactionMin);
  
  let playerBuzzed = false;
  
  playerBuzz.onclick = () => {
    if (gameState !== GameState.BUZZER_ACTIVE || playerBuzzed) return;
    playerBuzzed = true;
    buzzWinner = 'player';
    if (aiBuzzTimeout) clearTimeout(aiBuzzTimeout);
    handleBuzzWin();
  };
  
  aiBuzzTimeout = setTimeout(() => {
    if (gameState === GameState.BUZZER_ACTIVE && !playerBuzzed) {
      buzzWinner = 'ai';
      handleBuzzWin();
    }
  }, aiReactionTime);
}

function handleBuzzWin() {
  gameState = GameState.ANSWERING;
  playerBuzz.disabled = true;
  buzzSound();
  
  if (buzzWinner === 'player') {
    playerBuzz.classList.add('winner');
  } else {
    aiBuzz.classList.add('winner');
  }
  
  setTimeout(() => {
    buzzSection.classList.add('hidden');
    qTimer.style.visibility = 'visible';
    startAnswerTimer(currentQ.timeLimit || 10);
    showAnswerChoices(false, 0);
  }, 1000);
}

function showAnswerChoices(isDailyDouble, ddWager) {
  choices.innerHTML = '';
  
  currentQ.answers.forEach((t, idx) => {
    const b = document.createElement('button');
    b.className = 'choice';
    b.innerHTML = '<strong>' + String.fromCharCode(65 + idx) + '.</strong> ' + t;
    b.dataset.idx = idx;
    
    if (isDailyDouble) {
      if (currentTurn === 'player') {
        b.addEventListener('click', () => handleAnswer(idx, true, ddWager));
      } else {
        b.disabled = true;
      }
    } else {
      if (buzzWinner === 'player') {
        b.addEventListener('click', () => handleAnswer(idx, false, 0));
      } else {
        b.disabled = true;
      }
    }
    
    choices.appendChild(b);
  });
  
  if ((isDailyDouble && currentTurn === 'ai') || (!isDailyDouble && buzzWinner === 'ai')) {
    const aiSettings = AI_DIFFICULTY[currentDifficulty];
    const thinkTime = 1000 + Math.random() * 2000;
    
    setTimeout(() => {
      const correctAnswer = currentQ.correctIndex;
      let aiAnswer;
      
      if (Math.random() < aiSettings.accuracy) {
        aiAnswer = correctAnswer;
      } else {
        const wrongAnswers = [0, 1, 2, 3].filter(i => i !== correctAnswer);
        aiAnswer = wrongAnswers[Math.floor(Math.random() * wrongAnswers.length)];
      }
      
      handleAnswer(aiAnswer, isDailyDouble, ddWager);
    }, thinkTime);
  }
}

function handleAnswer(answerIdx, isDailyDouble, ddWager) {
  stopTimer();
  gameState = GameState.SHOWING_RESULT;
  
  [...choices.children].forEach(b => b.disabled = true);
  
  const correct = currentQ.correctIndex;
  const isCorrect = (answerIdx === correct);
  const answerer = isDailyDouble ? currentTurn : buzzWinner;
  const value = isDailyDouble ? ddWager : currentQ.pointValue;
  
  if (isCorrect) {
    choices.children[correct].classList.add('correct');
    if (answerer === 'player') {
      playerScore += value;
      pScore.textContent = '$' + playerScore;
    } else {
      aiScore += value;
      aiScoreEl.textContent = '$' + aiScore;
    }
    chordOK();
    celebrate();
    currentTurn = answerer;
  } else {
    if (answerIdx >= 0 && choices.children[answerIdx]) choices.children[answerIdx].classList.add('wrong');
    choices.children[correct].classList.add('correct');
    if (answerer === 'player') {
      playerScore -= value;
      pScore.textContent = '$' + playerScore;
    } else {
      aiScore -= value;
      aiScoreEl.textContent = '$' + aiScore;
    }
    buzzer();
    
    if (!isDailyDouble) {
      currentTurn = answerer === 'player' ? 'ai' : 'player';
    }
  }
  
  showExplanation(currentQ, isCorrect, answerer);
  closeQ.classList.remove('hidden');
}

function showExplanation(question, wasCorrect, answerer) {
  const answererName = answerer === 'player' ? 'You' : 'AI';
  const resultText = wasCorrect ? `‚úì ${answererName} answered correctly!` : `‚úó ${answererName} answered incorrectly`;
  
  const explanationDiv = document.createElement('div');
  explanationDiv.className = 'explanation';
  explanationDiv.innerHTML = `
    <h4>${resultText}</h4>
    <p><strong>Explanation:</strong> ${question.explanation}</p>
    ${question.reference ? `<p><small>üìö Reference: ${question.reference}</small></p>` : ''}
  `;
  feedback.appendChild(explanationDiv);
}

closeQ.addEventListener('click', () => {
  qCard.classList.remove('show');
  closeQ.classList.add('hidden');
  checkEndOrNext();
});

function checkEndOrNext() {
  questionsLeft = Object.values(tiles).filter(t => !t.used).length;
  qLeft.textContent = questionsLeft;
  
  if (questionsLeft === 0) {
    if (currentRound === 1) {
      startRound2();
    } else {
      openFinalJeopardy();
    }
  } else {
    gameState = GameState.TILE_SELECTION;
    updateTurnIndicator();
    
    if (currentTurn === 'ai') {
      aiSelectTile();
    }
  }
}

function openFinalJeopardy() {
  gameState = GameState.FINAL_JEOPARDY;
  fjCat.textContent = QUESTION_BANK.FINAL.cat;
  fjPScore.textContent = '$' + playerScore;
  fjAIScore.textContent = '$' + aiScore;
  fjPWager.max = Math.max(0, playerScore);
  fjPWager.value = Math.max(0, Math.min(playerScore, Math.floor(playerScore / 2)));
  fjAIWager.textContent = '$???';
  fjModal.classList.add('show');
}

fjStart.addEventListener('click', () => {
  const playerWager = Math.max(0, Math.min(playerScore, Number(fjPWager.value) || 0));
  
  let aiWager;
  if (aiScore > playerScore) {
    aiWager = Math.max(0, Math.min(aiScore, playerScore * 2 - aiScore + 100));
  } else {
    aiWager = Math.max(0, aiScore);
  }
  aiWager = Math.max(0, Math.min(aiScore, aiWager));
  
  fjModal.classList.remove('show');
  renderFinalQuestion(playerWager, aiWager);
});

function renderFinalQuestion(playerWager, aiWager) {
  finalCard.classList.add('show');
  finalCat.textContent = QUESTION_BANK.FINAL.cat;
  finalText.textContent = QUESTION_BANK.FINAL.question;
  finalChoices.innerHTML = '';
  finalFeedback.innerHTML = '';
  closeFinal.classList.add('hidden');
  
  QUESTION_BANK.FINAL.answers.forEach((t, idx) => {
    const b = document.createElement('button');
    b.className = 'choice';
    b.innerHTML = `<strong>${String.fromCharCode(65 + idx)}.</strong> ${t}`;
    b.addEventListener('click', () => {
      handleFinalAnswer(idx, playerWager, aiWager);
    });
    finalChoices.appendChild(b);
  });
}

function handleFinalAnswer(playerAnswerIdx, playerWager, aiWager) {
  [...finalChoices.children].forEach(b => b.disabled = true);
  
  const correct = QUESTION_BANK.FINAL.correctIndex;
  const playerCorrect = (playerAnswerIdx === correct);
  
  const aiSettings = AI_DIFFICULTY[currentDifficulty];
  const aiCorrect = Math.random() < (aiSettings.accuracy * 0.85);
  
  finalChoices.children[playerAnswerIdx].classList.add(playerCorrect ? 'correct' : 'wrong');
  if (!playerCorrect) {
    finalChoices.children[correct].classList.add('correct');
  }
  
  if (playerCorrect) {
    playerScore += playerWager;
  } else {
    playerScore -= playerWager;
  }
  
  if (aiCorrect) {
    aiScore += aiWager;
  } else {
    aiScore -= aiWager;
  }
  
  pScore.textContent = '$' + playerScore;
  aiScoreEl.textContent = '$' + aiScore;
  
  const expDiv = document.createElement('div');
  expDiv.className = 'explanation';
  expDiv.innerHTML = `
    <h4>Final Jeopardy Results</h4>
    <p><strong>Your answer:</strong> ${playerCorrect ? '‚úì Correct!' : '‚úó Incorrect'} (Wagered $${playerWager})</p>
    <p><strong>AI answer:</strong> ${aiCorrect ? '‚úì Correct!' : '‚úó Incorrect'} (Wagered $${aiWager})</p>
    <p><strong>Explanation:</strong> ${QUESTION_BANK.FINAL.explanation}</p>
    ${QUESTION_BANK.FINAL.reference ? `<p><small>üìö Reference: ${QUESTION_BANK.FINAL.reference}</small></p>` : ''}
  `;
  finalFeedback.appendChild(expDiv);
  
  if (playerCorrect) chordOK();
  else buzzer();
  
  closeFinal.classList.remove('hidden');
}

closeFinal.addEventListener('click', () => {
  finalCard.classList.remove('show');
  endGame();
});

function endGame() {
  gameState = GameState.GAME_OVER;
  gameEndModal.classList.add('show');

  endPlayerScore.textContent = '$' + playerScore;
  endAIScore.textContent = '$' + aiScore;

  if (playerScore > aiScore) {
    endGameTitle.textContent = 'üèÜ YOU WIN!';
    endGameMessage.textContent = `Congratulations! You defeated the AI ${AI_DIFFICULTY[currentDifficulty].name} opponent by $${playerScore - aiScore}. Excellent knowledge!`;
    celebrate();
  } else if (aiScore > playerScore) {
    endGameTitle.textContent = 'ü§ñ AI WINS!';
    endGameMessage.textContent = `The AI ${AI_DIFFICULTY[currentDifficulty].name} opponent won by $${aiScore - playerScore}. Review the explanations and try again!`;
  } else {
    endGameTitle.textContent = 'ü§ù TIE GAME!';
    endGameMessage.textContent = `You and the AI ${AI_DIFFICULTY[currentDifficulty].name} opponent tied! That's impressive.`;
  }

  // Auto-report score to parent page for gamification
  reportJeopardyScore(playerScore, aiScore);
}

function startAnswerTimer(timeLimit) {
  stopTimer();
  TMAX = timeLimit;
  t = TMAX;
  tLeft.textContent = t;
  tFill.style.transition = 'none';
  tFill.style.width = '100%';
  void tFill.offsetWidth;
  tFill.style.transition = 'width 1s linear';
  
  tInt = setInterval(() => {
    t--;
    tLeft.textContent = t;
    const percent = (t / TMAX) * 100;
    tFill.style.width = percent + '%';
    if (t <= 5 && t > 0) tick();
    if (t <= 0) {
      stopTimer();
      const isDD = ddBadge.style.display !== 'none';
      handleAnswer(-1, isDD, isDD ? currentDDWager : 0); // use stored DD wager on timeout
    }
  }, 1000);
}

function stopTimer() {
  clearInterval(tInt);
  tInt = null;
}

muteBtn.addEventListener('click', () => {
  soundOn = !soundOn;
  muteBtn.textContent = soundOn ? 'üîà Sound' : 'üîá Muted';
});

difficultyBtn.addEventListener('click', () => {
  const difficulties = ['easy', 'medium', 'hard', 'expert'];
  const currentIdx = difficulties.indexOf(currentDifficulty);
  currentDifficulty = difficulties[(currentIdx + 1) % difficulties.length];
  difficultyBtn.textContent = `AI: ${AI_DIFFICULTY[currentDifficulty].name}`;
});

finalRestartBtn.addEventListener('click', init);
document.addEventListener('click', () => { ensureAudio(); }, { once: true });

init();

// ============================================================================
// GAMIFICATION INTEGRATION - Auto-report score when game ends
// ============================================================================
function reportJeopardyScore(playerScore, aiScore) {
  const totalScore = playerScore + aiScore;
  const percentage = totalScore > 0 ? Math.round((playerScore / totalScore) * 100) : 0;

  try {
    if (window.parent && window.parent.completeModule) {
      window.parent.completeModule('jeopardy', percentage);
    }
  } catch(e) {
    // Running in standalone mode - no gamification
  }
}

window.reportJeopardyScore = reportJeopardyScore;
</script>

</body>
</html>
